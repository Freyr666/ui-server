<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="">
    <title>{{title}}</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto+Mono">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans">
    <link rel="stylesheet" href="/css/main.css" type="text/css">
    <style>
      @font-face {
      font-family: "Open Sans";
      src: url("https://fonts.googleapis.com/css?family=Open+Sans");
      }
    </style>
    <!-- Additional scripts -->
    {{#scripts}}
    <script src={{script}} type="text/javascript"></script>
    {{/scripts}}
    <!-- Additional stylesheets -->
    {{#stylesheets}}
    <link rel="stylesheet" href={{stylesheet}} type="text/css">open Widget
open Tyxml_js

(* Items *)

module Title = struct

  class t ?large ~title () = object
    inherit widget (Markup.Card.Primary.create_title ?large ~title () |> To_dom.of_h1) () as super

    method set_large x = Markup.Card.Primary.large_title_class
                         |> (fun c -> if x then super#add_class c else super#remove_class c)

    method get_title   = super#get_text_content |> CCOpt.get_or ~default:""
    method set_title s = super#set_text_content s
  end

end

module Subtitle = struct

  class t ~subtitle () = object
    inherit widget (Markup.Card.Primary.create_subtitle ~subtitle () |> To_dom.of_h2) () as super

    method get_subtitle   = super#get_text_content |> CCOpt.get_or ~default:""
    method set_subtitle s = super#set_text_content s
  end

end

module Media_item = struct

  class t ~widget () = object(self)

    val mutable height : [ `Height_1_5 | `Height_2 | `Height_3 ] option = None

    inherit Widget.widget widget () as super

    method get_height    = height
    method remove_height = (match height with
                            | None -> ()
                            | Some `Height_1_5 -> super#remove_class Markup.Card.Media_item.height_1dot5x_class
                            | Some `Height_2   -> super#remove_class Markup.Card.Media_item.height_2x_class
                            | Some `Height_3   -> super#remove_class Markup.Card.Media_item.height_3x_class);
                           height <- None
    method set_height x  = self#remove_height;
                           (match x with
                            | `Height_1_5 -> super#add_class Markup.Card.Media_item.height_1dot5x_class
                            | `Height_2   -> super#add_class Markup.Card.Media_item.height_2x_class
                            | `Height_3   -> super#add_class Markup.Card.Media_item.height_3x_class);
                           height <- Some x

    initializer
      super#add_class Markup.Card.Media_item._class

  end

  class image ~src () =
    let elt = Html.img ~src ~alt:"" () |> To_dom.of_img in

    object(self)
      inherit t ~widget:elt ()

      method image_element : Dom_html.imageElement Js.t = elt
      method get_src   = Js.to_string self#image_element##.src
      method set_src s = self#image_element##.src := Js.string s

    end
end

(* Sections *)

module Actions = struct

  class t ?vertical ~(widgets:#widget list) () =
    let elt = Markup.Card.Actions.create ?vertical ~children:(widgets_to_markup widgets) ()
              |> To_dom.of_section in
    object
      val mutable widgets : widget list = List.map (fun x -> (x :> Widget.widget)) widgets
      inherit widget elt () as super
      method get_widgets = widgets
      method set_vertical x = Markup.Card.Actions.vertical_class
                              |> (fun c -> if x then super#add_class c else super#remove_class c)

      initializer
        List.iter (fun x -> x#add_class Markup.Card.Actions.action_class) widgets
    end

end

module Media = struct

  class t ~(widgets:#widget list) () =
    let elt = Markup.Card.Media.create ~children:(widgets_to_markup widgets) ()
              |> To_dom.of_section in
    object
      val mutable widgets : widget list = List.map (fun x -> (x :> Widget.widget)) widgets
      inherit widget elt ()
      method get_widgets = widgets
    end

end

module Primary = struct

  class t ~(widgets:#widget list) () =

    let elt = Markup.Card.Primary.create ~children:(widgets_to_markup widgets) ()
              |> To_dom.of_section in

    object
      val mutable widgets : widget list = List.map (fun x -> (x :> Widget.widget)) widgets
      inherit widget elt ()
      method get_widgets = widgets
    end

end

module Supporting_text = struct

  class t ~text () =
    let elt = Markup.Card.Supporting_text.create ~children:[Html.pcdata text] ()
              |> To_dom.of_section in
    object
      inherit widget elt () as super
      method get_text   = super#get_text_content |> CCOpt.get_or ~default:""
      method set_text s = super#set_text_content s
    end

end

type sections = [ `Actions of Actions.t
                | `Media of Media.t
                | `Primary of Primary.t
                | `Text of Supporting_text.t ] list

class t ?(form=false) ~(sections:sections) () =
  let tag = if form then Some Tyxml_js.Html.form else None in
  let elt = Markup.Card.create ?tag ~sections:(List.map (function
                                                         | `Actions x -> widget_to_markup x
                                                         | `Media x   -> widget_to_markup x
                                                         | `Primary x -> widget_to_markup x
                                                         | `Text x    -> widget_to_markup x) sections)
                               ()
            |> Tyxml_js.To_dom.of_element in

  object(self)
    inherit widget elt ()
    val mutable sections = sections

    method get_sections = sections

    method get_primary = CCList.find_map (function `Primary x -> Some x | _ -> None) self#get_sections
    method get_actions = CCList.find_map (function `Actions x -> Some x | _ -> None) self#get_sections
    method get_media   = CCList.find_map (function `Media x -> Some x   | _ -> None) self#get_sections
    method get_text    = CCList.find_map (function `Text x -> Some x    | _ -> None) self#get_sections

    method get_all_primary = CCList.filter_map (function `Primary x -> Some x | _ -> None) self#get_sections
    method get_all_actions = CCList.filter_map (function `Actions x -> Some x | _ -> None) self#get_sections
    method get_all_media   = CCList.filter_map (function `Media x -> Some x   | _ -> None) self#get_sections
    method get_all_text    = CCList.filter_map (function `Text x -> Some x    | _ -> None) self#get_sections
  end

    {{/stylesheets}}
  </head>
  <body class="mdc-typography">
    <header class="mdc-toolbar mdc-toolbar--fixed">
      <div class="mdc-toolbar--row">
        <section class="mdc-toolbar__section mdc-toolbar__section--align-start">
          <a href="/" class="material-icons mdc-toolbar__menu-icon">menu</a>
          <span class="mdc-toolbar__title ui__title">АТС-3</span>
        </section>
      </div>
    </header>
    <div class="content mdc-toolbar-fixed-adjust">
      <nav class="mdc-permanent-drawer">
        <div class="mdc-list-group">
          <nav class="mdc-list">
            <a class="mdc-list-item" id="pipeline-button" href="#">
              <i class="material-icons mdc-list-item__start-detail" aria-hidden="true">multiline_chart</i>
              Pipeline
            </a>
            <a class="mdc-list-item" id="hardware-button" href="#">
                <i class="material-icons mdc-list-item__start-detail" aria-hidden="true">multiline_chart</i>
                Hardware
            </a>
            <a class="mdc-list-item" id="ip2ts-button" href="#">
                <i class="material-icons mdc-list-item__start-detail" aria-hidden="true">multiline_chart</i>
                IP2TS
            </a>
            <a class="mdc-list-item" href="#">
              <i class="material-icons mdc-list-item__start-detail" aria-hidden="true">multiline_chart</i>
              Мониторинг
            </a>
            <a class="mdc-list-item" href="#">
              <i class="material-icons mdc-list-item__start-detail" aria-hidden="true">developer_board</i>
              Конфигурация
            </a>
          </nav>
          <hr class="mdc-list-divider">
          <nav class="mdc-list">
            <a class="mdc-list-item" href="/settings/users">
              <i class="material-icons mdc-list-item__start-detail" aria-hidden="true">settings</i>
              Настройки
            </a>
            <a class="mdc-list-item" href="#">
              <i class="material-icons mdc-list-item__start-detail" aria-hidden="true">info</i>
              О приборе
            </a>
          </nav>
        </div>
      </nav>
      <main class="main-with-sidebar">
        <div id="arbitrary-script"></div>
        <section id="arbitrary-content">
          <div class="mdc-layout-grid">
            <div class="mdc-layout-grid__inner">
              {{#content}}
              {{{element}}}
              {{/content}}
            </div>
          </div>
        </section>
      </main>
    </div>
    <script src="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.js"></script>
    <script>
      function rdy () { window.mdc.autoInit(); };
      document.addEventListener('DOMContentLoaded', rdy, false);
    </script>
  </body>
</html>
